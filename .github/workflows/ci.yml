name: CI

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker compose config
        run: |
          docker compose -f docker-compose.yml config

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install lightweight deps (no Airflow)
        run: |
          python -m pip install --upgrade pip
          pip install duckdb redis kafka-python

      - name: Syntax check DAG
        run: |
          python -m py_compile airflow/dags/recommendation_dag.py

      - name: Import DAG with Airflow stubs
        run: |
          python - <<'PY'
          import sys, types, importlib.util

          # ---- create minimal "airflow" stubs so the DAG can import ----
          airflow = types.ModuleType("airflow")
          operators = types.ModuleType("airflow.operators")
          python_ops = types.ModuleType("airflow.operators.python")

          class DAG:
              def __init__(self, *args, **kwargs): pass
              def __enter__(self): return self
              def __exit__(self, exc_type, exc, tb): return False

          class PythonOperator:
              def __init__(self, *args, **kwargs): pass
              def __rshift__(self, other): return other

          airflow.DAG = DAG
          python_ops.PythonOperator = PythonOperator

          sys.modules["airflow"] = airflow
          sys.modules["airflow.operators"] = operators
          sys.modules["airflow.operators.python"] = python_ops

          # ---- import your DAG file ----
          p = "airflow/dags/recommendation_dag.py"
          spec = importlib.util.spec_from_file_location("recommendation_dag", p)
          m = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(m)
          print("DAG import OK (with stubs):", p)
          PY